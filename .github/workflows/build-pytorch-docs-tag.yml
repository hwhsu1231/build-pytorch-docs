name: build-pytorch-docs-tag

on:
  # Triggers the workflow on push or pull request events but only for the "master" branch
  push:
    branches: 
      - 'master'
    paths:
      - '.github/workflows/build-pytorch-docs-tag.yml'
  pull_request:
    branches: 
      - 'master'
    paths:
      - '.github/workflows/build-pytorch-docs-tag.yml'

  # Allows for the workflow to be manually started through the GitHub UI
  workflow_dispatch:

jobs:
  build-pytorch-docs-tag:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        # os: [ ubuntu-latest, windows-latest ]
    # runs-on: ubuntu-latest
    steps:
      - name: Check Contexts and Secrets
        run: |
          echo "[Contexts]"
          echo "github.job = ${{ github.job }}"
          echo "github.ref = ${{ github.ref }}"
          echo "github.ref_name = ${{ github.ref_name }}"
          echo "github.event_name = ${{ github.event_name }}"
          echo "runner.os = ${{ runner.os }}"
          echo "[Secrets]"
          echo "secrets.GITHUB_TOKEN = ${{ secrets.GITHUB_TOKEN }}"

      - name: Checkout to '${{ github.ref }}'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Npm Install 'katex'
        run: |
          npm install -g katex

      - name: Install Conda
        uses: s-weigand/setup-conda@v1
        with:
          update-conda: true
          activate-conda: false
          conda-channels: anaconda

      - name: Clone the PyTorch Repository
        run: |
          git clone \
            --depth=1 \
            --branch=v2.3.0 \
            https://github.com/pytorch/pytorch.git \
            pytorch

      # https://pypi.org/project/torchvision/
      - name: Install the PyTorch
        run: |
          cd pytorch
          python -m venv .venv
          source .venv/bin/activate
          # pip install torch==2.3.0
          pip install torch==2.3.0 torchvision==0.18.0 -f https://download.pytorch.org/whl/torch_stable.html

      - name: Build PyTorch Documentation
        # continue-on-error: true
        run: |
          cd pytorch
          source .venv/bin/activate
          pip install -r docs/requirements.txt
          make -C docs html

      # - name: Deploy to 'gh-pages' branch
      #   uses: JamesIves/github-pages-deploy-action@v4
      #   with:
      #     token: ${{ secrets.GITHUB_TOKEN }}
      #     branch: gh-pages
      #     folder: ./pytorch/docs/build/html
      #     target-folder: .
      #     clean: false
